class GameScene extends Phaser.Scene {
    constructor() {
        super({ key: "GameScene" });
        this.players = []; // エントリーしたプレイヤーを管理
    }

    preload() {
        this.load.image("background2", "assets/村.png");
        this.load.image("matchingButton", "assets/MATCHINGBUTTON.png");
        this.load.audio("newBgm", "assets/モノクロライブラリー.mp3");
    }

    create() {
        this.cameras.main.setBackgroundColor("#000000");
        this.children.removeAll();

        let bg = this.add.image(this.scale.width / 2, this.scale.height / 2, "background2");
        let scaleX = this.scale.width / bg.width;
        let scaleY = this.scale.height / bg.height;
        let scale = Math.max(scaleX, scaleY);
        bg.setScale(scale).setScrollFactor(0).setDepth(-5);

        this.add.text(this.scale.width / 2, 100, "ゲーム画面", {
            fontSize: "40px",
            fill: "#ffffff"
        }).setOrigin(0.5, 0.5).setDepth(1);

        this.matchingButton = this.add.image(this.scale.width / 2, 350, "matchingButton")
            .setInteractive()
            .setDepth(2)
            .setScale(0.5);

        this.matchingText = this.add.text(this.scale.width / 2, 450, "エントリー人数: 0/4", {
            fontSize: "30px",
            fill: "#ffffff"
        }).setOrigin(0.5, 0.5).setDepth(1);

        if (this.sound.get("bgm")) {
            this.sound.stopByKey("bgm");
        }
        if (!this.sound.get("newBgm")) {
            this.newBgm = this.sound.add("newBgm", { loop: true, volume: 0.5 });
            this.newBgm.play();
        }

        // マッチングボタンのクリックイベント
        this.matchingButton.on("pointerdown", () => {
            if (this.players.length < 4) {
                let playerId = this.players.length + 1;
                this.players.push("Player " + playerId);
                this.matchingText.setText(`エントリー人数: ${this.players.length}/4`);

                console.log(`Player ${playerId} がエントリーしました`);

                if (this.players.length === 4) {
                    this.startMatching();
                }
            }
        });
    }

    startMatching() {
        console.log("4人エントリー完了！チーム分け開始");

        // プレイヤーをシャッフルして2対2のチームを作成
        let shuffledPlayers = Phaser.Utils.Array.Shuffle(this.players);
        let team1 = [shuffledPlayers[0], shuffledPlayers[1]];
        let team2 = [shuffledPlayers[2], shuffledPlayers[3]];

        console.log("チーム 1:", team1);
        console.log("チーム 2:", team2);

        // チーム情報をバトルシーンへ渡して遷移
        this.scene.start("BattleScene", { team1, team2 });
    }
}
